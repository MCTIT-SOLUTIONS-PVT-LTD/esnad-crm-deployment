<html><head>
<meta charset="UTF-8">
<title>CRM Incident Dashboard</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #FAFAFA;
}

.dashboard-card {
  background: #fff;
  border-radius: 6px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  width: 98%;
  margin: 10px auto;
  padding: 10px;
}

.toolbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  background: #FAFAFA;
  padding: 10px;
  border-bottom: 1px solid #ddd;
}

.filter-group {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  align-items: center;
}

label {
  font-weight: bold;
  font-size: 14px;
}

input[type="date"], select {
  padding: 8px 10px;
  font-size: 14px;
  border: 1px solid #ccc;
  border-radius: 4px;
}


button:hover {
  background: #005ea2;
}

.clear-btn {
  background: #f4f4f4;
  color: #333;
  border: 1px solid #ccc;
}

.clear-btn:hover {
   background: #A58A60;
  color: #fff;
}

.export-dropdown {
  position: relative;
}

.export-btn {
  background: #A58A60; /* Primary Base */
  color: #fff;
  border: none;
  padding: 8px 14px;
  border-radius: 6px;
  font-size: 14px;
  cursor: pointer;
}
.export-btn:hover {
  background: #7E6A4C; /* Primary Dark */
}

.export-dropdown-menu {
  display: none;
  position: absolute;
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 6px;
  min-width: 160px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  top: 40px;
  right: 0;
  z-index: 1000;
}

.export-dropdown-menu.show {
  display: block;
}

.export-dropdown-menu button {
  width: 100%;
  padding: 10px;
  border: none;
  background: none;
  text-align: left;
  font-size: 14px;
}

.export-dropdown-menu button:hover {
 background: #7E6A4C; /* Primary Dark */
}

.table-container {
  overflow-x: auto;
  margin-top: 10px;
}

table {
  border-collapse: collapse;
  width: 100%;
  min-width: 1400px;
}

th, td {
  border: 1px solid #ccc;
  padding: 10px;
  text-align: left;
  white-space: nowrap;
}

th {
  background: #A58A60; /* Primary Base */
   color: #fff;
  position: sticky;
  top: 0;
  z-index: 100;
}

tr:nth-child(even) {
  background: #f9f9f9;
}

tr:hover {
  background: #F5F2ED; /* Very light tone */
}

.pagination-wrapper {
   display: flex;
  justify-content: center;  /* Centers all content horizontally */
  align-items: center;
  margin: 15px auto;
  gap: 20px;  /* Adds spacing between pagination, jump box, and info */
  text-align: center;
  width: 100%;
  flex-wrap: wrap; /* Responsive for small screens */
}

.pagination {
  display: flex;
  gap: 6px;
}

.pagination button {
  padding: 6px 12px;
   border: 1px solid #A58A60;
  background: #D7CAB2; /* Primary Light */
  cursor: pointer;
  border-radius: 4px;
  color: #5B4A35;
  font-size: 14px;
}

.pagination button.active {
  background: #A58A60;
  color: #fff;
  font-weight: bold;
}

.page-jump input {
  padding: 6px;
  width: 60px;
  text-align: center;
  border: 1px solid #ccc;
  border-radius: 4px;
}

.page-jump button {
  padding: 6px 10px;
  background: #A58A60;
  color: #fff;
  border-radius: 4px;
  margin-left: 5px;
}

.pagination-info {
   font-size: 14px;
  color: #555;
  font-weight: bold;
}
* Apply Filter Button */
button.apply-filter-btn {
  background: #D7CAB2 !important; /* Primary Light */
  color: #5B4A35 !important; /* Dark Text */
  border: 1px solid #A58A60 !important;
}
button.apply-filter-btn:hover {
   background: #A58A60 !important;
  color: #fff !important;
}

/* Clear Filters Button */
button.clear-btn {
  background: #D7CAB2 !important; /* Primary Light */
  color: #5B4A35 !important; /* Dark Text */
  border: 1px solid #A58A60 !important;
}
button.clear-btn:hover {
  background: #A58A60 !important;
  color: #fff !important;
}
</style>
<meta><meta><meta></head>
<body data-new-gr-c-s-check-loaded="14.1245.0" data-gr-ext-installed="" data-new-gr-c-s-loaded="14.1245.0" style="overflow-wrap: break-word;">
<div class="dashboard-card" style="font-family: undefined;">
  <div class="toolbar">
    <div class="filter-group">
      <label for="fromDate">From Date:</label>
      <input type="date" id="fromDate">

      <label for="toDate">To Date:</label>
      <input type="date" id="toDate">

      <label for="buSelect">Business Unit:</label>
      <select id="buSelect"><option value="">All</option></select>

      <label for="rowsPerPage">Rows per page:</label>
      <select id="rowsPerPage" onchange="changeRowsPerPage()">
        <option value="10" selected="">10</option>
        <option value="20">20</option>
        <option value="40">40</option>
      </select>

		<button class="apply-filter-btn" onclick="applyFilters()">Apply Filter</button>
		<button class="clear-btn" onclick="clearFilters()">Clear Filters</button>

    </div>

    <div class="export-dropdown">
  <button class="export-btn" id="exportToggle">‚¨á Export ‚ñº</button>
  <div id="exportDropdown" class="export-dropdown-menu">
    <button onclick="exportToExcel()">üìä Export to Excel</button>
    <button onclick="exportToPDF()">üìÑ Export to PDF</button>
  </div>
</div>

  </div>

  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>Ticket</th>
          <th>Title</th>
          <th>Priority</th>
          <th>Department</th>
          <th onclick="sortBy('createdon')">Created Date ‚ñ≤‚ñº</th>
          <th>Current Responsible Employee</th>
          <th>Ticket Type</th>
          <th>Customer</th>
          <th>Ticket Creator (Employee)</th>
          <th>Status</th>
          <th>Ticket Submission Channel</th>
          <th>Beneficiary Type</th>
          <th>Request Type</th>
          <th>Description</th>
          <th>Solution Description</th>
          <th>Ticket Resolved Date</th>
        </tr>
      </thead>
      <tbody id="incidentTableBody"></tbody>
    </table>
    <div class="pagination-wrapper" id="paginationContainer"></div>

  </div>
</div>

<script>
let incidentData = [];
let filteredData = [];
let currentPage = 1;
let rowsPerPage = 20;
let currentSortColumn = null;
let currentSortDirection = 'desc'; // or 'desc'

document.getElementById("exportToggle").addEventListener("click", function (e) {
  e.stopPropagation(); // Prevent event bubbling
  const dropdown = document.getElementById("exportDropdown");
  dropdown.classList.toggle("show");
});

// Close dropdown when clicking outside
document.addEventListener("click", function (e) {
  const dropdown = document.getElementById("exportDropdown");
  if (dropdown.classList.contains("show")) {
    dropdown.classList.remove("show");
  }
});

// ‚úÖ On Page Load
window.onload = async function () {
  const today = new Date().toISOString().split("T")[0];
  document.getElementById("fromDate").value = today; // Show today's date
  document.getElementById("toDate").value = today;
    await loadBusinessUnits(); // ‚úÖ Load BU Dropdown
  await fetchIncidentData();
  renderTable(incidentData); // ‚úÖ Show all records initially
};


const context = typeof Xrm !== "undefined" ? Xrm : (typeof parent.Xrm !== "undefined" ? parent.Xrm : null);
if (!context) {
  alert("‚ö†Ô∏è This web resource must be opened within Dynamics 365.");
  throw new Error("‚ùå Xrm context not found.");
}

function renderTable(data) {
  const tbody = document.getElementById("incidentTableBody");
  tbody.innerHTML = "";

  if (data.length === 0) {
    const tableContainer = document.querySelector(".table-container");
    const tbody = document.getElementById("incidentTableBody");
    tbody.innerHTML = "";

    // ‚úÖ Add centered message
    tbody.innerHTML = `
        <tr>
            <td colspan="16" style="
                text-align: center;
                font-size: 20px;
                font-weight: bold;
                color: #7E6A4C;
                padding: 100px;
            ">
                No tickets found for the selected date range or business unit.
            </td>
        </tr>
    `;

    // ‚úÖ Hide pagination when no records
    document.getElementById("paginationContainer").style.display = "none";

    return; // Exit function
} else {
    // ‚úÖ Show pagination if there are records
    document.getElementById("paginationContainer").style.display = "flex";
}


  rowsPerPage = parseInt(document.getElementById("rowsPerPage").value || "20");
  const startIndex = (currentPage - 1) * rowsPerPage;
  const pageData = data.slice(startIndex, startIndex + rowsPerPage);

  pageData.forEach(item => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${item.ticketnumber}</td>
      <td>${item.title}</td>
      <td>${item.prioritycode}</td>
      <td>${item.departmentname}</td>
      <td>${item.createdonStr}</td>
      <td>${item.currentEmployee}</td>
      <td>${item.ticketType}</td>
      <td>${item.customer}</td>
      <td>${item.createdBy}</td>
      <td>${item.status}</td>
      <td>${item.submissionChannel}</td>
      <td>${item.beneficiaryType}</td>
      <td>${item.requestType}</td>
      <td>${item.description}</td>
      <td>${item.solutiondescription}</td>
      <td>${item.resolvebyStr}</td>
    `;
    tbody.appendChild(row);
  });

  renderPagination();
}
function changeRowsPerPage() {
  rowsPerPage = parseInt(document.getElementById("rowsPerPage").value);
  currentPage = 1; // reset to first page
  renderTable(filteredData.length ? filteredData : incidentData);
}

async function loadBusinessUnits() {
    try {
        const result = await context.WebApi.retrieveMultipleRecords("businessunit", "?$select=name,businessunitid");
        const buSelect = document.getElementById("buSelect");

        result.entities.forEach(bu => {
            const opt = document.createElement("option");
            opt.value = bu.businessunitid.toLowerCase();
            opt.text = bu.name;
            buSelect.appendChild(opt);
        });
    } catch (error) {
        console.error("Error loading Business Units:", error);
    }
}

function renderPagination() {
  const container = document.getElementById("paginationContainer");
  container.innerHTML = "";

  const totalRecords = filteredData.length || incidentData.length;
  const totalPages = Math.ceil(totalRecords / rowsPerPage);
  if (totalPages <= 1) return;

  const wrapper = document.createElement("div");
  wrapper.className = "pagination-wrapper";

  // ‚úÖ Pagination Buttons
  const paginationButtons = document.createElement("div");
  paginationButtons.className = "pagination";

  // Previous Button
  const prevBtn = createButton("Prev", () => {
    if (currentPage > 1) {
      currentPage--;
      renderTable(filteredData.length ? filteredData : incidentData);
    }
  }, currentPage === 1);
  paginationButtons.appendChild(prevBtn);

  // Show only 5 pages at a time
  const visiblePages = 5;
  let startPage = Math.max(1, currentPage - 2);
  let endPage = Math.min(totalPages, currentPage + 2);

  if (startPage > 1) {
    paginationButtons.appendChild(createPageButton(1));
    if (startPage > 2) paginationButtons.appendChild(createDots());
  }

  for (let i = startPage; i <= endPage; i++) {
    paginationButtons.appendChild(createPageButton(i, i === currentPage));
  }

  if (endPage < totalPages) {
    if (endPage < totalPages - 1) paginationButtons.appendChild(createDots());
    paginationButtons.appendChild(createPageButton(totalPages));
  }

  // Next Button
  const nextBtn = createButton("Next", () => {
    if (currentPage < totalPages) {
      currentPage++;
      renderTable(filteredData.length ? filteredData : incidentData);
    }
  }, currentPage === totalPages);
  paginationButtons.appendChild(nextBtn);

  // ‚úÖ Jump to Page Feature
  const pageJump = document.createElement("div");
  pageJump.className = "page-jump";

  const jumpInput = document.createElement("input");
  jumpInput.type = "number";
  jumpInput.placeholder = "Page";
  jumpInput.min = 1;
  jumpInput.max = totalPages;

  const goBtn = document.createElement("button");
  goBtn.textContent = "Go";
  goBtn.onclick = () => {
    const page = parseInt(jumpInput.value);
    if (page >= 1 && page <= totalPages) {
      currentPage = page;
      renderTable(filteredData.length ? filteredData : incidentData);
    } else {
      alert(`Enter a valid page number (1-${totalPages})`);
    }
  };

  pageJump.appendChild(jumpInput);
  pageJump.appendChild(goBtn);

  // ‚úÖ Showing Info
  const info = document.createElement("div");
  info.className = "pagination-info";
  const start = (currentPage - 1) * rowsPerPage + 1;
  const end = Math.min(currentPage * rowsPerPage, totalRecords);
  info.innerText = `Showing ${start}‚Äì${end} of ${totalRecords} results`;

  // Combine Everything
  wrapper.appendChild(paginationButtons);
  wrapper.appendChild(pageJump);
  wrapper.appendChild(info);

  container.appendChild(wrapper);

  function createButton(text, onClick, disabled = false) {
    const btn = document.createElement("button");
    btn.innerText = text;
    btn.disabled = disabled;
    btn.onclick = onClick;
    return btn;
  }

  function createPageButton(page, active = false) {
    const btn = document.createElement("button");
    btn.textContent = page;
    if (active) btn.classList.add("active");
    btn.onclick = () => {
      currentPage = page;
      renderTable(filteredData.length ? filteredData : incidentData);
    };
    return btn;
  }

  function createDots() {
    const span = document.createElement("span");
    span.textContent = "...";
    return span;
  }
}

function exportToExcel() {
    // Get filter values
    const fromDate = document.getElementById("fromDate").value || "All";
    const toDate = document.getElementById("toDate").value || "All";
    const buSelect = document.getElementById("buSelect");
    const buName = buSelect.options[buSelect.selectedIndex].text || "All";

    // Prepare file name
    const fileName = `${fromDate}_to_${toDate}_${buName}_Incidents.xlsx`;

    // Prepare sheet name (Excel allows max 31 chars)
    const sheetName = `${fromDate}_${toDate}`.substring(0, 31);

    // Get data
    const data = filteredData.length ? filteredData : incidentData;

    // Convert to Excel
    const ws = XLSX.utils.json_to_sheet(data.map(d => ({
        "Ticket": d.ticketnumber,
        "Title": d.title,
        "Priority": d.prioritycode,
        "Department": d.departmentname,
        "Created Date": d.createdonStr,
        "Current Responsible Employee": d.currentEmployee,
        "Ticket Type": d.ticketType,
        "Customer": d.customer,
        "Ticket Creator": d.createdBy,
        "Status": d.status,
        "Ticket Submission Channel": d.submissionChannel,
        "Beneficiary Type": d.beneficiaryType,
        "Request Type": d.requestType,
        "Description": d.description,
        "Solution Description": d.solutiondescription,
        "Resolved Date": d.resolvebyStr
    })));

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, sheetName);
    XLSX.writeFile(wb, fileName);
}


function exportToPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('l', 'pt', 'a4'); // Landscape for better table fit

    // ‚úÖ Dynamic File Name (same as Excel)
    const fromDate = document.getElementById("fromDate").value || "All";
    const toDate = document.getElementById("toDate").value || "All";
    const buSelect = document.getElementById("buSelect");
    const buName = buSelect.options[buSelect.selectedIndex].text || "All";
    const fileName = `${fromDate}_to_${toDate}_${buName}_Incidents.pdf`;

    // ‚úÖ Add Title
    doc.setFontSize(16);
    doc.text("Incident Report", 40, 30);
    doc.setFontSize(12);
    doc.text(`Date Range: ${fromDate} to ${toDate}`, 40, 50);
    doc.text(`Business Unit: ${buName}`, 40, 70);

    // ‚úÖ Prepare Table Data
    const data = (filteredData.length ? filteredData : incidentData).map(d => [
        d.ticketnumber,
        d.title,
        d.prioritycode,
        d.departmentname,
        d.createdonStr,
        d.currentEmployee,
        d.ticketType,
        d.customer,
        d.createdBy,
        d.status
    ]);

    // ‚úÖ Define Headers
    const headers = [
        ["Ticket #", "Title", "Priority", "Department", "Created Date",
         "Employee", "Ticket Type", "Customer", "Created By", "Status"]
    ];

    // ‚úÖ Use AutoTable Plugin for PDF Table
    if (doc.autoTable) {
        doc.autoTable({
            head: headers,
            body: data,
            startY: 90,
            theme: 'grid',
            styles: { fontSize: 8, cellPadding: 3 },
            headStyles: { fillColor: [165, 138, 96] }, // Brown Header (matches your theme)
        });
    } else {
        console.error("AutoTable plugin is required for PDF table export.");
    }

    // ‚úÖ Save PDF with dynamic name
    doc.save(fileName);
}


function clearFilters() {
  const today = new Date().toISOString().split("T")[0];
  document.getElementById("fromDate").value = today;
  document.getElementById("toDate").value = today;
  document.getElementById("buSelect").value = "";
  document.getElementById("rowsPerPage").value = "20";
  currentPage = 1;
  filteredData = [];
  renderTable(incidentData);
}

const fetchXml = `
<fetch top="500">
  <entity name="incident">
    <attribute name="ticketnumber" />
    <attribute name="title" />
    <attribute name="description" />
    <attribute name="new_solutiondescription" />
    <attribute name="resolveby" />
    <attribute name="prioritycode" />
    <attribute name="createdon" />
    <attribute name="ownerid" />
    <attribute name="new_tickettype" />
    <attribute name="customerid" />
    <attribute name="createdby" />
    <attribute name="statecode" />
    <attribute name="new_ticketsubmissionchannel" />
    <attribute name="new_beneficiarytype" />
    <attribute name="new_requesttype" />
    <attribute name="new_businessunitid" />
    <order attribute="createdon" descending="true" />
    <link-entity name="businessunit" from="businessunitid" to="new_businessunitid" alias="dept">
      <attribute name="name" />
    </link-entity>
  </entity>
</fetch>`;

async function fetchIncidentData() {
  const result = await context.WebApi.retrieveMultipleRecords("incident", "?fetchXml=" + encodeURIComponent(fetchXml));
  incidentData = result.entities.map(rec => {
    const created = new Date(rec.createdon);
    const resolvedDate = rec.resolveby ? new Date(rec.resolveby) : null;
    return {
        ticketnumber: rec.ticketnumber || "",
        title: rec.title || "",
        description: rec.description || "",
        solutiondescription: rec.new_solutiondescription || "",
        resolvebyStr: resolvedDate ? resolvedDate.toLocaleString() : "",
        prioritycode: rec.prioritycode ? ["Critical", "High", "Medium", "Low"][rec.prioritycode - 1] : "",
        createdon: created,
        createdonStr: created.toLocaleDateString(),
        currentEmployee: rec["_ownerid_value@OData.Community.Display.V1.FormattedValue"] || "",
        ticketType: rec["_new_tickettype_value@OData.Community.Display.V1.FormattedValue"] || "",
        customer: rec["_customerid_value@OData.Community.Display.V1.FormattedValue"] || "",
        createdBy: rec["_createdby_value@OData.Community.Display.V1.FormattedValue"] || "",
        status: rec["statecode@OData.Community.Display.V1.FormattedValue"] || "",
        submissionChannel: rec["new_ticketsubmissionchannel@OData.Community.Display.V1.FormattedValue"] || "",
        beneficiaryType: rec["new_beneficiarytype@OData.Community.Display.V1.FormattedValue"] || "",
        requestType: rec["new_requesttype@OData.Community.Display.V1.FormattedValue"] || "",
        departmentname: rec["dept.name"] || "",
        businessunitid: rec["_new_businessunitid_value"]?.toLowerCase() || "" // ‚úÖ Added BU ID
    };
});

}
function sortBy(column) {
  // Toggle sort direction
  if (currentSortColumn === column) {
    currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
  } else {
    currentSortColumn = column;
    currentSortDirection = 'asc';
  }

  // Sort filteredData or incidentData
  let dataToSort = filteredData.length ? filteredData : incidentData;

  dataToSort.sort((a, b) => {
    let aVal = a[column];
    let bVal = b[column];

    if (column === 'createdon') {
      aVal = new Date(aVal);
      bVal = new Date(bVal);
    }

    if (aVal < bVal) return currentSortDirection === 'asc' ? -1 : 1;
    if (aVal > bVal) return currentSortDirection === 'asc' ? 1 : -1;
    return 0;
  });

  renderTable(dataToSort);

  // Update header arrow
  const createdHeader = document.querySelector('#createdonHeader');
  if (createdHeader) {
    createdHeader.innerHTML = `Created Date ${currentSortDirection === 'asc' ? '‚ñ≤' : '‚ñº'}`;
  }
}

function applyFilters() {
    const fromDate = document.getElementById("fromDate").value;
    const toDate = document.getElementById("toDate").value;
    const buId = document.getElementById("buSelect").value.toLowerCase();

    const from = fromDate ? new Date(fromDate + "T00:00:00") : null;
    const to = toDate ? new Date(toDate + "T23:59:59") : null;

    filteredData = incidentData.filter(item => {
        let match = true;
        if (from) match = item.createdon >= from;
        if (to) match = match && item.createdon <= to;
        if (buId) match = match && item.businessunitid === buId; 
        return match;
    });

    if (!from && !to && !buId) filteredData = [...incidentData];

    currentPage = 1;
    renderTable(filteredData);
}

</script>


<grammarly-desktop-integration data-grammarly-shadow-root="true"></grammarly-desktop-integration></body></html>